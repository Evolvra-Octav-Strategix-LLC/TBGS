root@212:/opt/tbgs# # Create a proper production server fix
cat > production-serdocker-compose down
                    # Create a proper production server fix
cat > production-serdocker-compose down
                    # Create a proper production server fix
cat > production-server-fix.js << 'EOF'
import express from "express";
import { registerRoutes } from "./routes";
import { log, setupVite, serveStatic } from "./vite";
import { taskProcessor } from "./taskQueue";

const app = express();

// Middleware with increased limits for webhook endpoints
app.use('/api/email-webhook', express.json({ limit: '50mb' }));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

async function startServer() {
  try {
    // Register API routes first
    const server = await registerRoutes(app);
    
    // Use static serving in production, Vite in development
    if (process.env.NODE_ENV === 'production') {
      serveStatic(app);
      log('Production mode: serving static files from dist/public');
    } else {
      await setupVite(app, server);
      log('Development mode: using Vite dev server');
    }

    const port = process.env.PORT || 5000;
    server.listen(port, () => {
      log(`serving on port ${port}`);
      
      // Start background task processor
      taskProcessor.start();
    });
  } catch (error) {
    console.error("Failed to start server:", error);
curl -I http://localhostppr-fix.js tbgs-app:/app/dist/index.js
Successfully copied 3.07kB to tbgs-app:/app/dist/index.js
Error response from daemon: No such container: tbgs-app
WARN[0000] /opt/tbgs/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
[+] Running 7/7
 ✔ Network tbgs_tbgs-network  Created                                                                                                     0.1s 
 ✔ Container tbgs-certbot     Started                                                                                                     0.4s 
 ✔ Container tbgs-postgres    Started                                                                                                     0.5s 
 ✔ Container tbgs-redis       Started                                                                                                     0.4s 
 ✔ Container tbgs-app         Started                                                                                                     0.6s 
 ✔ Container tbgs-nextcloud   Started                                                                                                     0.7s 
 ✔ Container tbgs-nginx       Started                                                                                                     1.0s 
WARN[0000] /opt/tbgs/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
NAME       IMAGE           COMMAND                  SERVICE    CREATED          STATUS                    PORTS
tbgs-app   tbgs-tbgs-app   "/sbin/tini -- node …"   tbgs-app   11 seconds ago   Up 10 seconds (healthy)   3000/tcp
HTTP/1.1 500 Internal Server Error
Server: nginx
Date: Tue, 09 Sep 2025 22:47:14 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 148
Connection: keep-alive
X-Powered-By: Express
Vary: Origin
Content-Security-Policy: default-src 'none'
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin

root@212:/opt/tbgs# 
